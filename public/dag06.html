<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>tinyML4D Ecosystem DAG Viewer (Static Demo)</title>
    <!-- Load Tailwind CSS for simple, modern styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'primary': '#4CAF50', // Green for tinyML4D
                        'secondary': '#FF9800', // Orange for contrast
                    },
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    }
                }
            }
        }
    </script>
    <!-- Load vis-network (Community Edition) for Graph Visualization -->
    <script type="text/javascript" src="https://unpkg.com/vis-network/standalone/umd/vis-network.min.js"></script>

    <style>
        /* CSS for Resizable Container */
        #myNetworkContainer {
            /* Enable vertical and horizontal resizing */
            resize: both;
            overflow: auto; 
            min-height: 300px; 
            width: 100%;
            height: 500px; 
            border-radius: 0.5rem;
            border: 2px solid #ccc;
        }
        
        .my-button-style:hover {
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            transform: translateY(-1px);
        }
    </style>
</head>
<body class="bg-gray-50 p-4 sm:p-8 font-sans">

    <!-- Global Canvas Environment Variables Setup (Mandatory) -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Global variables provided by the Canvas environment
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null;
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        let db, auth;

        // Simplified Initialization for visualization (Firestore not used for storage)
        if (firebaseConfig) {
            const app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app);
            
            // Sign in process
            if (initialAuthToken) {
                signInWithCustomToken(auth, initialAuthToken).catch(myError => console.error("Custom token sign-in failed:", myError));
            } else {
                signInAnonymously(auth).catch(myError => console.error("Anonymous sign-in failed:", myError));
            }
        }
        // Exposing global variables for potential future use (though not needed for this visualization)
        window.myAppId = appId;
    </script>

    <div class="max-w-4xl mx-auto">
        <header class="text-center mb-6">
            <h1 class="text-3xl font-bold text-primary">tinyML4D Ecosystem DAG (Static Demo)</h1>
            <p class="text-gray-600 mt-1">Interactive visualization of different stakeholder perspectives <span class="font-semibold text-gray-500">(Directed Acyclic Graph)</span>.</p>
        </header>

        <!-- View Selector Buttons -->
        <div id="myViewSelectors" class="flex flex-wrap justify-center gap-3 mb-8">
            <button onclick="myLoadView('All')" class="my-button-style bg-primary hover:bg-green-700 text-white font-semibold py-2 px-4 rounded-lg transition duration-150 ease-in-out">
                All Nodes
            </button>
            <button onclick="myLoadView('Professor')" class="my-button-style bg-blue-500 hover:bg-blue-600 text-white font-semibold py-2 px-4 rounded-lg transition duration-150 ease-in-out">
                Professor View
            </button>
            <button onclick="myLoadView('Industry')" class="my-button-style bg-orange-500 hover:bg-orange-600 text-white font-semibold py-2 px-4 rounded-lg transition duration-150 ease-in-out">
                Industry View
            </button>
            <button onclick="myLoadView('OpenSource')" class="my-button-style bg-purple-500 hover:bg-purple-600 text-white font-semibold py-2 px-4 rounded-lg transition duration-150 ease-in-out">
                Open Source View
            </button>
            <button onclick="myLoadView('Funding')" class="my-button-style bg-yellow-500 hover:bg-yellow-600 text-gray-800 font-semibold py-2 px-4 rounded-lg transition duration-150 ease-in-out">
                Funding View
            </button>
            <button onclick="myLoadView('MLSysBook')" class="my-button-style bg-indigo-500 hover:bg-indigo-600 text-white font-semibold py-2 px-4 rounded-lg transition duration-150 ease-in-out">
                MLSysBook View
            </button>
             <button onclick="myClearStorageAndReset()" class="my-button-style bg-red-500 hover:bg-red-700 text-white font-semibold py-2 px-4 rounded-lg transition duration-150 ease-in-out">
                Reset Views
            </button>
        </div>

        <!-- Visualization Container -->
        <div id="myNetworkContainer" class="shadow-lg bg-white"></div>
        
        <!-- Info Panel for Interactivity -->
        <div id="myInfoPanel" class="mt-6 p-4 bg-white rounded-lg shadow-md border-l-4 border-primary">
            <h3 class="text-xl font-semibold text-gray-800">Node Information</h3>
            <p id="myNodeDetails" class="text-gray-600 mt-2">Click on a node in the graph to see its details here.</p>
        </div>
    </div>

    <script>
        // Global variable to hold the currently active view name for detail filtering
        let myCurrentView = 'All';

        // --- STATIC DATA FOR DEMO ---
        const myMasterDagData = {
            nodes: [
                // Professor View Nodes
                { id: 1, label: 'Prof. Alice', group: 'Professor', title: 'Leads the Embedded ML Lab.' },
                { id: 2, label: 'BME Project', group: 'Project', title: 'tinyML in Biomedical Engineering' },
                { id: 3, label: 'Student John', group: 'Student', title: 'Working on BME Project', chaptersFinished: 8, details: { GPA: 3.8, Progress: '75% Complete', Thesis: 'ECG Analysis on Edge Device' } },
                { id: 4, label: 'Paper 1', group: 'Publication', title: 'IEEE Transactions on ML' },
                { id: 5, label: 'Student Jane', group: 'Student', title: 'PhD Candidate', chaptersFinished: 12, details: { GPA: 4.0, Progress: '100% Complete', Thesis: 'Federated Learning on IoT' } },
                
                // Industry View Nodes
                { id: 6, label: 'ChipCorp', group: 'Industry', title: 'Major chip manufacturer' },
                { id: 7, label: 'EdgeSense', group: 'Business', title: 'Startup focused on tinyML solutions' },
                { id: 8, label: 'Sensor Dev Kit', group: 'Hardware', title: 'Low-power sensor kit' },
                { id: 9, label: 'Logistics Project', group: 'Project', title: 'Optimizing warehouse logistics with tinyML' },
                
                // Open Source View Nodes
                { id: 10, label: 'ML Framework X', group: 'OpenSource', title: 'Popular tinyML optimization library' },
                { id: 11, label: 'DIY Maker 1', group: 'Maker', title: 'Hobbyist contributing to device drivers' },
                { id: 12, label: 'Tutorial Project', group: 'Project', title: 'Beginner friendly ML project guide' },
                
                // Funding/Educator View Nodes
                { id: 13, label: 'NSF Grant', group: 'Funding', title: 'National Science Foundation Research Grant' },
                { id: 14, label: 'Educator Sam', group: 'Educator', title: 'Teaches Intro to Embedded Systems', chaptersFinished: 9 },
                
                // MLSysBook View Specific Nodes (Educator, Student, Audit)
                { id: 15, label: 'Educator Maya', group: 'Educator', title: 'Coordinates a cohort for the MLSys Book', chaptersFinished: 11 },
                { id: 16, label: 'Student Ken', group: 'Student', title: 'Enrolled in MLSysBook course', chaptersFinished: 4 },
                { id: 17, label: 'Audit Visitor', group: 'Audit', title: 'Reads the book without formal grading.' }, // Audit Group Node
                { id: 18, label: 'Audit Observer', group: 'Audit', title: 'Following public lectures only.' }, // Audit Group Node

                // Additional generic nodes to connect
                { id: 19, label: 'Data Collection', group: 'Project', title: 'General data pipeline phase' },
            ],
            edges: [
                // Professor View
                { from: 1, to: 2, label: 'Leads' },
                { from: 2, to: 3, label: 'Involves' },
                { from: 3, to: 4, label: 'Wrote based on' },
                { from: 1, to: 5, label: 'Supervises' },
                { from: 5, to: 4, label: 'Contributed to' },

                // Industry View
                { from: 6, to: 8, label: 'Developed' },
                { from: 7, to: 9, label: 'Needs' },
                { from: 9, to: 8, label: 'Uses' },
                { from: 6, to: 2, label: 'Sponsors' },

                // Open Source View
                { from: 10, to: 12, label: 'Used in' },
                { from: 11, to: 10, label: 'Contributes to' },
                
                // Funding/Educator View
                { from: 13, to: 2, label: 'Funds' },
                { from: 13, to: 14, label: 'Supports' },

                // MLSysBook View
                { from: 15, to: 16, label: 'Instructs' },
                { from: 15, to: 17, label: 'Provides Content to' },
                { from: 16, to: 19, label: 'Performs' },
                { from: 17, to: 18, label: 'Interacts with' } // Audit to Audit example
            ]
        };

        /**
         * @function myGetStaticViewData
         * @description Filters the master graph data based on the requested view name.
         * @param {string} myViewName The name of the view to load ('All', 'Professor', etc.).
         * @returns {object} Filtered nodes and edges.
         */
        function myGetStaticViewData(myViewName) {
            let myAllowedGroups;
            
            switch (myViewName) {
                case 'Professor':
                    myAllowedGroups = ['Professor', 'Student', 'Publication', 'Project'];
                    break;
                case 'Industry':
                    myAllowedGroups = ['Industry', 'Project', 'Hardware', 'Business', 'Student'];
                    break;
                case 'OpenSource':
                    myAllowedGroups = ['OpenSource', 'Maker', 'Project', 'Hardware'];
                    break;
                case 'Funding':
                    myAllowedGroups = ['Funding', 'Project', 'Educator', 'Professor'];
                    break;
                case 'MLSysBook':
                    // User requested groups: Educator, Student, Audit
                    myAllowedGroups = ['Educator', 'Student', 'Audit', 'Project']; 
                    break;
                case 'All':
                default:
                    // Include all known groups
                    myAllowedGroups = ['Professor', 'Industry', 'OpenSource', 'Funding', 'Project', 'Student', 'Hardware', 'Publication', 'Educator', 'Audit', 'Maker', 'Business'];
                    break;
            }

            // Filter nodes
            const myFilteredNodes = myMasterDagData.nodes.filter(node => myAllowedGroups.includes(node.group));
            const myFilteredNodeIds = myFilteredNodes.map(node => node.id);

            // Filter edges (only keep edges between nodes that are still present)
            const myFilteredEdges = myMasterDagData.edges.filter(edge => 
                myFilteredNodeIds.includes(edge.from) && myFilteredNodeIds.includes(edge.to)
            );

            return {
                nodes: myFilteredNodes,
                edges: myFilteredEdges,
            };
        }


        // --- Core Rendering Function ---

        /**
         * @function myRenderNetwork
         * @description Initializes and renders the vis-network graph in a specified container.
         * @param {string} myContainerId The ID of the HTML element to draw the network in.
         * @param {object} myData The data object containing nodes and edges arrays.
         * @param {string} myCurrentViewName The name of the view currently active (for detail filtering).
         * @returns {void}
         */
        async function myRenderNetwork(myContainerId, myData, myCurrentViewName) {
            const myContainer = document.getElementById(myContainerId);
            // Clear previous graph
            myContainer.innerHTML = '';

            // Use DataSet objects for better dynamic handling
            const myNodes = new vis.DataSet(myData.nodes);
            const myEdges = new vis.DataSet(myData.edges);
            
            const myGraphData = { nodes: myNodes, edges: myEdges };

            // Configuration options for the DAG layout and node styling
            const myOptions = {
                // Disabling physics simulation for static, hierarchical layout
                physics: { enabled: false }, 
                layout: {
                    hierarchical: {
                        enabled: true,
                        direction: 'UD', // Up-Down flow (DAG)
                        sortMethod: 'directed',
                        levelSeparation: 150,
                        nodeSpacing: 120,
                    }
                },
                groups: {
                    // Shapes updated to 'box' or 'square' to ensure labels are inside
                    Professor: { color: { background: '#2196F3', border: '#1565C0' }, shape: 'box', font: { color: 'white' } }, // Blue (Box)
                    Industry: { color: { background: '#FF9800', border: '#E65100' }, shape: 'box', font: { color: 'white' } }, // Orange (Box)
                    OpenSource: { color: { background: '#9C27B0', border: '#4A148C' }, shape: 'box', font: { color: 'white' } }, // Purple (Box)
                    Funding: { color: { background: '#FFEB3B', border: '#FBC02D' }, shape: 'box', font: { color: 'black' } }, // Yellow (Box)
                    Project: { color: { background: '#4CAF50', border: '#2E7D32' }, shape: 'square', font: { color: 'white' } }, // Green (Square)
                    Student: { color: { background: '#795548', border: '#3E2723' }, shape: 'ellipse', font: { color: 'white' } }, // Brown (Ellipse for distinction)
                    Hardware: { color: { background: '#607D8B', border: '#37474F' }, shape: 'square', font: { color: 'white' } }, // Gray (Square)
                    Publication: { color: { background: '#00BCD4', border: '#00838F' }, shape: 'text', font: { color: 'black' } }, // Cyan (Text)
                    Educator: { color: { background: '#00BFA5', border: '#00796B' }, shape: 'square', font: { color: 'white' } }, // Teal (Square)
                    Audit: { color: { background: '#673AB7', border: '#512DA8' }, shape: 'dot', font: { color: 'white' } }, // Deep Purple (Dot for non-interactive user)
                    Maker: { color: { background: '#E91E63', border: '#C2185B' }, shape: 'square', font: { color: 'white' } }, // Pink (Square)
                    Business: { color: { background: '#D32F2F', border: '#B71C1C' }, shape: 'box', font: { color: 'white' } }, // Dark Red (Box)
                },
                // Add click event handling
                interaction: {
                    hover: true,
                    tooltipDelay: 100,
                }
            };

            const myNetwork = new vis.Network(myContainer, myGraphData, myOptions);

            // Add simple event listener (as per user preference, using network.on)
            myNetwork.on('click', (myProperties) => {
                const myNodeDetails = document.getElementById('myNodeDetails');
                const myClickedNodeId = myProperties.nodes[0]; // Get the ID of the clicked node

                if (myClickedNodeId) {
                    // Need to look up the node data from the DataSet
                    const myNode = myNodes.get(myClickedNodeId);
                    const myGroupConfig = myOptions.groups[myNode.group] || {};
                    const myGroupColor = myGroupConfig.color ? myGroupConfig.color.background : '#333';

                    // Base details visible to all
                    let myDetailsHtml = `
                        <p><strong>Name/Title:</strong> ${myNode.label}</p>
                        <p><strong>Role:</strong> <span class="text-xs font-mono px-2 py-1 rounded-full text-white" style="background-color: ${myGroupColor}">${myNode.group}</span></p>
                        <p><strong>Description:</strong> ${myNode.title}</p>
                    `;
                    
                    // --- Differentiated Data View Logic ---
                    if ((myCurrentViewName === 'Professor' || myCurrentViewName === 'All') && myNode.group === 'Student' && myNode.details) {
                        // Professor View sees student performance/academic data
                        myDetailsHtml += `
                            <hr class="my-2 border-dashed">
                            <p class="font-bold text-blue-600">ACADEMIC DETAILS (${myCurrentViewName} View)</p>
                            <p><strong>GPA:</strong> <span class="font-semibold text-green-700">${myNode.details.GPA}</span></p>
                            <p><strong>Thesis Progress:</strong> ${myNode.details.Progress}</p>
                            <p><strong>Thesis Topic:</strong> ${myNode.details.Thesis}</p>
                        `;
                    }
                    
                    // --- MLSysBook Progress View Logic ---
                    // Check if chaptersFinished exists AND the group is NOT 'Audit'
                    const myShowProgress = (myCurrentViewName === 'MLSysBook' || myCurrentViewName === 'All') && 
                                           myNode.chaptersFinished !== undefined && 
                                           myNode.group !== 'Audit'; // <--- EXPLICITLY hides progress for Audit group

                    if (myShowProgress) {
                        myDetailsHtml += `
                            <hr class="my-2 border-dashed">
                            <p class="font-bold text-indigo-600">MLSYSBOOK.AI PROGRESS (${myCurrentViewName} View)</p>
                            <p><strong>Chapters Finished:</strong> <span class="font-semibold text-indigo-700">${myNode.chaptersFinished} / 12</span></p>
                        `;
                    } else if (myCurrentViewName === 'MLSysBook' && myNode.group === 'Audit') {
                         // Add the specific Audit heading for clarity in this view
                        myDetailsHtml += `
                            <hr class="my-2 border-dashed">
                            <p class="font-bold text-purple-600">MLSYSBOOK.AI AUDIT STATUS</p>
                            <p>Progress data is not tracked for Audit participants.</p>
                        `;
                    }
                    
                    myNodeDetails.innerHTML = myDetailsHtml;
                } else {
                    myNodeDetails.innerHTML = "Click on a node in the graph to see its details here.";
                }
            });
            
            // Save the current view name to local storage (for UI persistence)
            mySaveCurrentViewName(myCurrentViewName);
        }


        // --- Local Storage Functions (Only for UI State) ---

        /**
         * @function mySaveCurrentViewName
         * @description Saves the currently active view name to local storage.
         * @param {string} myViewName The key under which to save the data.
         */
        function mySaveCurrentViewName(myViewName) {
            try {
                localStorage.setItem('dagLastView', myViewName);
            } catch (myError) {
                console.error("Error saving view name to local storage:", myError);
            }
        }

        /**
         * @function myClearStorageAndReset
         * @description Clears the last view key and reloads the default 'All' view.
         */
        function myClearStorageAndReset() {
            try {
                localStorage.removeItem('dagLastView');
                console.log("Local storage cleared. Reloading All Nodes view.");
                myLoadView('All');
            } catch (myError) {
                console.error("Error resetting local storage:", myError);
            }
        }


        // --- View Loading Functions (Now uses static data) ---

        /**
         * @function myLoadView
         * @description Gets the required graph data from the static object and renders the network.
         * @param {string} myViewName The name of the view to load ('All', 'Professor', etc.).
         * @returns {void}
         */
        async function myLoadView(myViewName) {
            myCurrentView = myViewName; // Update global state
            
            const myNodeDetailsElement = document.getElementById('myNodeDetails');
            myNodeDetailsElement.innerText = `Loading ${myViewName} View... Please wait.`;

            try {
                // Get data directly from the static function
                const myDataToRender = myGetStaticViewData(myViewName);
                
                // Render the fetched data
                await myRenderNetwork('myNetworkContainer', myDataToRender, myViewName);
                myNodeDetailsElement.innerText = `Loaded ${myViewName} View. Click a node for details.`;

            } catch (myError) {
                console.error("Error loading view data from static data:", myError);
                myNodeDetailsElement.innerHTML = `<p class="text-red-600 font-bold">Error loading view: ${myViewName}.</p>`;
            }
        }

        // --- Initial Load ---

        window.onload = () => {
            // Load the last view the user was on, or default to 'All'
            const myLastView = localStorage.getItem('dagLastView') || 'All';
            myLoadView(myLastView); 
        };
    </script>
</body>
</html>
