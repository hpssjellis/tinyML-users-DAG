<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>tinyML4D Ecosystem DAG Viewer (Interactive Clustering)</title>
    <!-- Load Tailwind CSS for simple, modern styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'primary': '#4CAF50', // Green for tinyML4D
                        'secondary': '#FF9800', // Orange for contrast
                    },
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    }
                }
            }
        }
    </script>
    <!-- Load vis-network (Community Edition) for Graph Visualization -->
    <script type="text/javascript" src="https://unpkg.com/vis-network/standalone/umd/vis-network.min.js"></script>

    <style>
        /* CSS for Resizable Container */
        #myNetworkContainer {
            /* Enable vertical and horizontal resizing */
            resize: both;
            overflow: auto; 
            min-height: 300px; 
            width: 100%;
            height: 450px; 
            border-radius: 0.5rem;
            border: 2px solid #ccc;
        }
        
        .my-button-style:hover {
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            transform: translateY(-1px);
        }
    </style>
</head>
<body class="bg-gray-50 p-4 sm:p-8 font-sans">

    <!-- Global Canvas Environment Variables Setup (Mandatory) -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Global variables provided by the Canvas environment
        const myAppId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const myFirebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null;
        const myInitialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        let myDb, myAuth;

        if (myFirebaseConfig) {
            const myApp = initializeApp(myFirebaseConfig);
            myDb = getFirestore(myApp);
            myAuth = getAuth(myApp);
            
            if (myInitialAuthToken) {
                signInWithCustomToken(myAuth, myInitialAuthToken).catch(myError => console.error("Custom token sign-in failed:", myError));
            } else {
                signInAnonymously(myAuth).catch(myError => console.error("Anonymous sign-in failed:", myError));
            }
        }
    </script>

    <div class="max-w-4xl mx-auto">
        <header class="text-center mb-6">
            <h1 class="text-3xl font-bold text-primary">tinyML4D Ecosystem DAG (Interactive Clustering)</h1>
            <p class="text-gray-600 mt-1">Click a Cluster node to expand. Double-click the background to contract all. Drag nodes to save position.</p>
        </header>

        <!-- View Selector Buttons -->
        <div id="myViewSelectors" class="flex flex-wrap justify-center gap-3 mb-8">
            <button onclick="myLoadView('All')" class="my-button-style bg-primary hover:bg-green-700 text-white font-semibold py-2 px-4 rounded-lg transition duration-150 ease-in-out">
                All Nodes
            </button>
            <button onclick="myLoadView('Professor')" class="my-button-style bg-blue-500 hover:bg-blue-600 text-white font-semibold py-2 px-4 rounded-lg transition duration-150 ease-in-out">
                Professor View
            </button>
            <button onclick="myLoadView('ClusteredStudent')" class="my-button-style bg-blue-800 hover:bg-blue-900 text-white font-semibold py-2 px-4 rounded-lg transition duration-150 ease-in-out">
                Clustered Student View (Demo)
            </button>
            <button onclick="myLoadView('MLSysBook')" class="my-button-style bg-indigo-500 hover:bg-indigo-600 text-white font-semibold py-2 px-4 rounded-lg transition duration-150 ease-in-out">
                MLSysBook View
            </button>
            
            <button onclick="myLoadView('Industry')" class="my-button-style bg-orange-600 hover:bg-orange-700 text-white font-semibold py-2 px-4 rounded-lg transition duration-150 ease-in-out">
                Industry View (Recruiting Focus)
            </button>
            <button onclick="myLoadView('Discord')" class="my-button-style bg-teal-600 hover:bg-teal-700 text-white font-semibold py-2 px-4 rounded-lg transition duration-150 ease-in-out">
                Discord View (Community)
            </button>
            <button onclick="myLoadView('LinkedIn')" class="my-button-style bg-cyan-700 hover:bg-cyan-800 text-white font-semibold py-2 px-4 rounded-lg transition duration-150 ease-in-out">
                LinkedIn View (Professional)
            </button>
            <button onclick="myLoadView('GitHub')" class="my-button-style bg-gray-900 hover:bg-gray-700 text-white font-semibold py-2 px-4 rounded-lg transition duration-150 ease-in-out">
                GitHub View (Dev Focus)
            </button>
            <button onclick="myLoadView('Funding')" class="my-button-style bg-yellow-600 hover:bg-yellow-700 text-white font-semibold py-2 px-4 rounded-lg transition duration-150 ease-in-out">
                Funding & Grants
            </button>
            <button onclick="myLoadView('Admin')" class="my-button-style bg-red-700 hover:bg-red-800 text-white font-semibold py-2 px-4 rounded-lg transition duration-150 ease-in-out">
                Admin View (Weighted)
            </button>
            
             <!-- Replaced 'Reset Views' with 'Save View as JSON' for download functionality -->
            <button onclick="mySaveViewAsJson()" class="my-button-style bg-gray-500 hover:bg-gray-700 text-white font-semibold py-2 px-4 rounded-lg transition duration-150 ease-in-out">
                Save View as JSON (Download)
            </button>
        </div>

        <!-- Visualization Container -->
        <div id="myNetworkContainer" class="shadow-lg bg-white"></div>
        
        <!-- Info Panel for Interactivity -->
        <div id="myInfoPanel" class="mt-6 p-4 bg-white rounded-lg shadow-md border-l-4 border-primary">
            <h3 class="text-xl font-semibold text-gray-800">Node Information</h3>
            <p id="myNodeDetails" class="text-gray-600 mt-2">Click on a node for details, **double-click** a node or edge to edit. You can also **drag nodes** to save their positions globally.</p>
        </div>
    </div>

    <!-- --- POPUP EDITOR MODAL (NEW) --- -->
    <div id="myEditorModal" class="fixed inset-0 bg-gray-900 bg-opacity-75 hidden items-center justify-center p-4 z-50 transition-opacity duration-300" style="display: none;">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-md max-h-[90vh] overflow-y-auto transform scale-100 transition-transform duration-300">
            <div class="p-6">
                <h2 id="myEditorTitle" class="text-2xl font-bold text-gray-800 border-b pb-2 mb-4">Edit Item</h2>
                <form id="myEditorForm" onsubmit="mySaveChanges(event)">
                    <!-- Dynamic fields will be appended here -->
                    <div id="myEditorFields" class="space-y-3">
                        <!-- Inputs will be injected by JavaScript -->
                    </div>
                    <input type="hidden" id="myEditorItemId" name="id">
                    <input type="hidden" id="myEditorItemType" name="type">
                    <div class="flex justify-end space-x-3 mt-6">
                        <button type="button" onclick="myCloseEditor()" class="px-4 py-2 bg-gray-200 text-gray-700 font-medium rounded-lg hover:bg-gray-300 transition">
                            Close
                        </button>
                        <button type="submit" class="px-4 py-2 bg-primary text-white font-medium rounded-lg hover:bg-green-700 transition">
                            Save Changes
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    <!-- -------------------------------- -->

    <script>
        let myCurrentView = 'All';
        let myNetwork = null;
        let myGlobalNodes = null; // Single Source of Truth for ALL nodes
        let myGlobalEdges = null; // Single Source of Truth for ALL edges
        let myDefaultNodeOptions = {}; // To store default options for color lookup

        // --- STATIC DATA FOR DEMO (EXPANDED AND VARIED) ---
        const myMasterDagData = {
            nodes: [
                // Professors
                { id: 'P1', label: 'Dr. Anita Sharma', group: 'Professor', title: 'Specializes in Efficient ML', chaptersFinished: 12 },
                { id: 'P2', label: 'Dr. Jane Doe', group: 'Professor', title: 'Interested in Industry & Ethics', chaptersFinished: 10 },
                { id: 'P3', label: 'Prof. Kenji Sato', group: 'Professor', title: 'Focus on Deployment & Hardware', chaptersFinished: 8 },
                
                // Student Nodes
                { id: 'S1', label: 'Student: Maria R.', group: 'Student', location: 'London', title: 'Researching pruning algorithms', chaptersFinished: 8 },
                { id: 'S2', label: 'Student: Ben K.', group: 'Student', location: 'Lagos', title: 'Developing OS1 integration', chaptersFinished: 5 },
                { id: 'S3', label: 'Student: Kai L.', group: 'Student', location: 'London', title: 'Focus on Industry-ready prototypes', chaptersFinished: 9 },
                { id: 'S4', label: 'Student: Zoe V.', group: 'Student', location: 'Lima', title: 'Edge sensor network deployment', chaptersFinished: 7 },
                { id: 'S5', label: 'Student: Alex J.', group: 'Student', location: 'Lagos', title: 'Model quantization research', chaptersFinished: 10 },
                { id: 'S6', label: 'Student: Eli F.', group: 'Student', location: 'London', title: 'Low-latency deployment strategy', chaptersFinished: 11 }, 
                { id: 'S7', label: 'Student: Sam P.', group: 'Student', location: 'Remote', title: 'Deep involvement in FOSS development (High GitHub)', chaptersFinished: 6 },
                { id: 'S8', label: 'Student: Leo B.', group: 'Student', location: 'Berlin', title: 'Career focus, networking, thesis writing (High LinkedIn)', chaptersFinished: 4 },
                { id: 'S9', label: 'Student: Ana T.', group: 'Student', location: 'Online', title: 'Passive auditor, active community member (High Discord)', chaptersFinished: 2 },
                
                // Industry Entities
                { id: 'I1', label: 'Ecom Electronics', group: 'Industry', title: 'Sponsor of the Edge AI Project (Hiring)', type: 'Recruiter' },
                { id: 'I2', label: 'SensorCo', group: 'Industry', title: 'Hardware vendor and sensor integration partner', type: 'Vendor' },
                { id: 'I3', label: 'ML Consulting Group', group: 'Industry', title: 'Provides high-level strategy and recruitment for tinyML', type: 'Consultancy' },
                
                // K-12 Educators (UPDATED WITH NEW NODES)
                { id: 'E2', label: 'Sarah L. (HS Teacher)', group: 'K-12 Educator', title: 'Developing high school tinyML curriculum.', chaptersFinished: 8 },
                { id: 'E3', label: 'David M. (Curriculum)', group: 'K-12 Educator', title: 'Focus on ethical AI education and outreach.', chaptersFinished: 10 },
                { id: 'E4', label: 'K-12: Suzie A.', group: 'K-12 Educator', title: 'Active in global K-12 network and content sharing.' },
                { id: 'E5', label: 'K-12: Jeremy B.', group: 'K-12 Educator', title: 'STEM Educator focusing on physical computing projects.' },
                
                // Makers
                { id: 'M1', label: 'Chris P.', group: 'Maker', title: 'Prototyping custom sensor hardware/Open Source Contributor.' },
                { id: 'M2', label: 'Aisha K.', group: 'Maker', title: 'Active in online workshops and local maker spaces.' },

                // Employees (Hired from the ecosystem)
                { id: 'Em1', label: 'Javier G. (Recruit)', group: 'Employee', title: 'Former student (S5), now R&D at Ecom Electronics (I1).', status: 'Alumnus' },
                { id: 'Em2', label: 'Rina O. (Tech Lead)', group: 'Employee', title: 'Embedded Systems lead at SensorCo (I2).', status: 'Liaison' },

                // Other Entities
                { id: 'OS1', label: 'TinyMLx Library', group: 'OpenSource', title: 'Key tinyML toolkit, MIT License' },
                { id: 'OS2', label: 'TFLite Micro Repo', group: 'OpenSource', title: 'External GitHub repo for TFLM project' },
                { id: 'PrA', label: 'Edge AI Project', group: 'Project', title: 'Focus: Low-power CV on microcontrollers' },
                { id: 'PrB', label: 'Model Compression Paper', group: 'Publication', title: 'Published in ICCV 2025' },
                { id: 'H1', label: 'ARM M0 Module', group: 'Hardware', title: 'Target deployment hardware' },
                { id: 'E1', label: 'Maker Workshop', group: 'Educator', title: 'Teaches practical tinyML implementation', chaptersFinished: 12 },
                { id: 'A1', label: 'Audit: Observer 1', group: 'Audit', title: 'Reads content without formal enrollment.' },
                { id: 'F1', label: 'Green Tech Fund', group: 'Funding', title: 'Focus on sustainable technology' },
                { id: 'F2', label: 'EU Horizon Grant', group: 'Funding', title: 'Large scale European Research Grant' },
                
                // Social Entities
                { id: 'D1', label: 'Discord Server', group: 'Discord', title: 'Community Support Channel' },
                { id: 'L1', label: 'LinkedIn Group', group: 'LinkedIn', title: 'Professional Networking & Recruiting' },
                { id: 'G1', label: 'GitHub Organization', group: 'GitHub', title: 'Central development hub for the ecosystem' },

                // ADMIN NODE
                { id: 'Ad1', label: 'System Admin: Chris B.', group: 'Admin', title: 'Manages Industry & Faculty Relations' },
            ],
            edges: [
                // Professor P1 (Anita) links
                { from: 'P1', to: 'S1', label: 'Supervises', arrows: 'to' },
                { from: 'P1', to: 'S2', label: 'Supervises', myWeight: 0.40, title: 'Needs Development/Support (0.40)', arrows: 'to' }, 
                { from: 'P1', to: 'PrA', label: 'Leads', arrows: 'to' },
                { from: 'P1', to: 'S6', label: 'Supervises', arrows: 'to' }, 
                { from: 'P1', to: 'I2', label: 'Partners with', arrows: 'to' }, 
                { from: 'S1', to: 'PrB', label: 'Contributed to', arrows: 'to' }, 
                // Professor P2 (Jane) links
                { from: 'P2', to: 'S3', label: 'Supervises', myWeight: 0.95, title: 'High Ability/Connectedness (0.95)', arrows: 'to' }, 
                { from: 'P2', to: 'S4', label: 'Supervises', arrows: 'to' }, 
                { from: 'P2', to: 'S5', label: 'Supervises', arrows: 'to' }, 
                { from: 'P2', to: 'I1', label: 'Collaborates with', arrows: 'to' },
                { from: 'P2', to: 'L1', label: 'Moderates Group', arrows: 'to' }, 
                // Professor P3 (Kenji) links
                { from: 'P3', to: 'S7', label: 'Supervises', arrows: 'to' }, 
                { from: 'P3', to: 'S8', label: 'Supervises', arrows: 'to' }, 
                { from: 'P3', to: 'H1', label: 'Designs for', arrows: 'to' }, 
                { from: 'P3', to: 'OS2', label: 'Contributes to', arrows: 'to' }, 

                // Student Project/Hardware links
                { from: 'PrA', to: 'OS1', label: 'Uses Toolkit', arrows: 'to' },
                { from: 'S3', to: 'I1', label: 'Prototypes for', arrows: 'to' }, 
                { from: 'S2', to: 'OS1', label: 'Maintains', arrows: 'to' }, 
                { from: 'S4', to: 'H1', label: 'Tests on', arrows: 'to' }, 
                { from: 'S7', to: 'H1', label: 'Deployment Specialist', arrows: 'to' }, 
                { from: 'S7', to: 'G1', label: 'Active Committer', arrows: 'to' }, 
                { from: 'S8', to: 'I3', label: 'Internship at', arrows: 'to' }, 
                
                // Industry Links
                { from: 'I2', to: 'H1', label: 'Provides chipsets to', arrows: 'to' },
                { from: 'I3', to: 'L1', label: 'Recruits from', arrows: 'to' },
                { from: 'I1', to: 'S6', label: 'Recruits', arrows: 'to' },

                // Funding/Education
                { from: 'F1', to: 'PrA', label: 'Grants', arrows: 'to' },
                { from: 'F2', to: 'P2', label: 'Awarded to', arrows: 'to' },
                { from: 'E1', to: 'S5', label: 'Teaches', arrows: 'to' }, 
                { from: 'E1', to: 'A1', label: 'Provides material to', arrows: 'to' },
                
                // Social Links
                { from: 'E1', to: 'D1', label: 'Manages Community', arrows: 'to' }, 
                { from: 'S2', to: 'D1', label: 'Active Member', arrows: 'to' }, 
                { from: 'S9', to: 'D1', label: 'Passive Member', arrows: 'to' }, 
                { from: 'OS1', to: 'D1', label: 'Provides Support on', arrows: 'to' }, 
                { from: 'I1', to: 'L1', label: 'Recruits from', arrows: 'to' }, 
                { from: 'F1', to: 'L1', label: 'Promotes Opportunities on', arrows: 'to' },
                { from: 'S8', to: 'L1', label: 'High Networker', arrows: 'to' }, 
                { from: 'P3', to: 'L1', label: 'Posts Industry News', arrows: 'to' }, 
                { from: 'OS1', to: 'G1', label: 'Mirrors Code to', arrows: 'to' },
                { from: 'OS2', to: 'G1', label: 'Forked from', arrows: 'to' },
                { from: 'P3', to: 'G1', label: 'Sponsor', arrows: 'to' },
                
                // ADMIN WEIGHTED CONNECTIONS (Unchanged)
                { from: 'Ad1', to: 'P1', label: 'Collaboration', myWeight: 1.0, title: 'Positive Conference Interaction (1.0)', arrows: 'to' }, 
                { from: 'Ad1', to: 'I1', label: 'Recruiting Relationship', myWeight: 0.85, title: 'Formal Industry Partnership (0.85)', arrows: 'to' }, 
                { from: 'Ad1', to: 'S3', label: 'Mentoring', myWeight: 0.55, title: 'Frequent Online Check-ins (0.55)', arrows: 'to' }, 
                { from: 'Ad1', to: 'F1', label: 'Funding Pipeline', myWeight: 0.90, title: 'Secured Annual Funding (0.90)', arrows: 'to' }, 
                { from: 'Ad1', to: 'D1', label: 'Community Oversight', myWeight: 0.20, title: 'Occasional Check-ins (0.20)', arrows: 'to' },
                
                // --- K-12 Educator Connections (UPDATED WITH NEW EDGES) ---
                { from: 'E2', to: 'E1', label: 'Collaborates on curriculum', arrows: 'to' }, 
                { from: 'E2', to: 'D1', label: 'Seeks implementation support', arrows: 'to' },
                { from: 'P2', to: 'E3', label: 'Ethics Consultant for', arrows: 'to' },
                { from: 'E3', to: 'PrB', label: 'Cites for outreach material', arrows: 'to' },
                
                { from: 'E4', to: 'D1', label: 'Shares curriculum', arrows: 'to' }, // Suzie to Discord
                { from: 'E5', to: 'PrA', label: 'Tests project materials', arrows: 'to' }, // Jeremy to Project
                { from: 'E4', to: 'E3', label: 'Co-develops ethics module', arrows: 'to' },
                { from: 'P1', to: 'E5', label: 'Provides technical guidance', arrows: 'to' }, // Professor to Jeremy
                
                // Maker Connections
                { from: 'M1', to: 'H1', label: 'Prototype development', arrows: 'to' }, 
                { from: 'M1', to: 'G1', label: 'Shares designs on', arrows: 'to' },
                { from: 'M2', to: 'D1', label: 'Manages Community Channel', arrows: 'to' },
                { from: 'M2', to: 'E1', label: 'Co-runs public workshops', arrows: 'to' },
                
                // Employee Connections
                { from: 'S5', to: 'Em1', label: 'Alumni Peer', arrows: 'to' },
                { from: 'Em1', to: 'I1', label: 'Hired by', arrows: 'to' },
                { from: 'Em1', to: 'L1', label: 'Professional Profile', arrows: 'to' },
                { from: 'Em2', to: 'I2', label: 'Embedded Systems Lead', arrows: 'to' },
                { from: 'Em2', to: 'G1', label: 'Technical Oversight', arrows: 'to' },
                { from: 'Em2', to: 'P3', label: 'Liaison with', arrows: 'to' },
            ]
        };
        
        // Configuration for Network groups (re-used in logic)
        myDefaultNodeOptions = {
            Professor: { color: { background: '#2196F3', border: '#1565C0' }, shape: 'box', font: { color: 'white' } }, 
            Industry: { color: { background: '#FF9800', border: '#E65100' }, shape: 'box', font: { color: 'white' } }, 
            OpenSource: { color: { background: '#9C27B0', border: '#4A148C' }, shape: 'box', font: { color: 'white' } }, 
            Funding: { color: { background: '#FFEB3B', border: '#FBC02D' }, shape: 'box', font: { color: 'black' } }, 
            Project: { color: { background: '#4CAF50', border: '#2E7D32' }, shape: 'square', font: { color: 'white' } }, 
            Student: { color: { background: '#795548', border: '#3E2723' }, shape: 'ellipse', font: { color: 'white' } }, 
            Hardware: { color: { background: '#607D8B', border: '#37474F' }, shape: 'square', font: { color: 'white' } }, 
            Educator: { color: { background: '#00BFA5', border: '#00796B' }, shape: 'square', font: { color: 'white' } }, 
            Audit: { color: { background: '#673AB7', border: '#512DA8' }, shape: 'dot', font: { color: 'white' } }, 
            Discord: { color: { background: '#7289DA', border: '#4E5D94' }, shape: 'hexagon', font: { color: 'white' } }, 
            LinkedIn: { color: { background: '#0A66C2', border: '#004182' }, shape: 'square', font: { color: 'white' } }, 
            GitHub: { color: { background: '#171515', border: '#000000' }, shape: 'star', font: { color: 'white' } }, 
            Admin: { color: { background: '#A00000', border: '#600000' }, shape: 'star', font: { color: 'white', size: 18 } }, 
            StudentCluster: { color: { background: '#3F51B5', border: '#1A237E', highlight: '#5C6BC0' }, font: { color: 'white' } },
            
            // --- NEW GROUP STYLES ---
            'K-12 Educator': { color: { background: '#F44336', border: '#C62828' }, shape: 'diamond', font: { color: 'white' } },
            'Maker': { color: { background: '#8BC34A', border: '#558B2F' }, shape: 'triangle', font: { color: 'black' } },
            'Employee': { color: { background: '#FFC107', border: '#FF8F00' }, shape: 'box', font: { color: 'black' } },
        };


        // --- Color Utility for Edge Weight ---

        /**
         * @function myWeightToColor
         * @description Converts a float weight (0.0 to 1.0) to a dark green color string.
         */
        function myWeightToColor(myWeight) {
            // Scale weight from a light green (75) to a dark green (255) intensity in the G channel
            const myWeightIntensity = Math.floor(myWeight * 180) + 75; 
            return { 
                color: `rgb(0, ${myWeightIntensity}, 0)`, 
                highlight: `rgb(0, ${myWeightIntensity + 30}, 0)`,
                inherit: 'false',
                opacity: 1
            };
        }
        
        /**
         * @function myProcessEdgeForVisuals
         * @description Updates an edge object's visualization properties based on its myWeight property.
         */
        function myProcessEdgeForVisuals(myEdge) {
            const myNewEdge = { ...myEdge }; 
            
            if (myNewEdge.myWeight !== undefined) {
                const myWeight = parseFloat(myNewEdge.myWeight);
                
                // 1. Update label to show the weight clearly
                const myBaseLabel = myNewEdge.label.split(' (')[0];
                myNewEdge.label = `${myBaseLabel} (${myWeight.toFixed(2)})`; 

                // 2. Use weight to determine thickness (from 1 to 5)
                myNewEdge.width = 1 + (myWeight * 4); 

                // 3. Use weight to determine color 
                myNewEdge.color = myWeightToColor(myWeight);
                
                if (!myNewEdge.arrows) myNewEdge.arrows = 'to';
            }
            return myNewEdge;
        }

        // --- VIS-NETWORK CLUSTERING FUNCTIONS ---

        /**
         * @function myApplyClustering
         * @description Applies clustering logic to the network based on the Student's location.
         */
        function myApplyClustering() {
            if (!myNetwork || !myGlobalNodes) return;
            
            // Check if clusters already exist to avoid double-clustering
            if (myNetwork.getClusteredNodeIds().some(myId => myId.startsWith('cluster_student_'))) {
                 // Contraction logic: re-render the view which implicitly contracts clusters not in the visible ID list
                 myLoadView(myCurrentView);
                 return;
            }

            const myLocations = ['London', 'Lagos', 'Lima', 'Remote', 'Berlin', 'Online']; // Locations to cluster by

            myLocations.forEach((myLocation) => {
                const myClusterOptions = {
                    joinCondition: (myNodeData) => {
                        // Check against the global data set
                        const myNode = myGlobalNodes.get(myNodeData.id);
                        return myNode && myNode.group === 'Student' && myNode.location === myLocation;
                    },
                    clusterNodeProperties: {
                        id: `cluster_student_${myLocation}`,
                        label: `Students in ${myLocation}`,
                        title: `Click to view ${myLocation} students.`,
                        group: 'StudentCluster', 
                        shape: 'database',
                        font: { size: 16, color: 'white', face: 'Inter' }
                    }
                };
                
                // Only cluster if nodes for this view are present
                const myVisibleNodes = myNetwork.body.data.nodes.getIds();
                const myNodesToCluster = myVisibleNodes.filter(myId => myGlobalNodes.get(myId)?.location === myLocation);
                
                if(myNodesToCluster.length > 0) {
                     myNetwork.cluster(myClusterOptions);
                }
            });
            
            console.log("Interactive Student Clustering Applied.");
        }


        /**
         * @function myRenderNetwork
         * @description Initializes and renders the vis-network graph using a filtered DataView.
         * @param {string} myContainerId The ID of the container element.
         * @param {object} myVisibleIds Object containing arrays of nodeIds and edgeIds to display.
         * @param {string} myCurrentViewName The name of the current view.
         * @returns {vis.Network} The network instance.
         */
        async function myRenderNetwork(myContainerId, myVisibleIds, myCurrentViewName) {
            const myContainer = document.getElementById(myContainerId);
            myContainer.innerHTML = '';

            // 1. Create DataViews filtered by the visible IDs (this is the key to persistence)
            const myNodesView = new vis.DataView(myGlobalNodes, {
                filter: (myNode) => myVisibleIds.nodeIds.includes(myNode.id)
            });

            const myEdgesView = new vis.DataView(myGlobalEdges, {
                filter: (myEdge) => myVisibleIds.edgeIds.includes(myEdge.id)
            });
            
            const myGraphData = { nodes: myNodesView, edges: myEdgesView };

            const myOptions = {
                // FIX: Disable physics after the initial layout to prevent the entire view from moving on drag.
                physics: { enabled: false }, 
                layout: {
                    hierarchical: {
                        enabled: true,
                        direction: 'UD', 
                        sortMethod: 'directed',
                        levelSeparation: 150,
                        nodeSpacing: 120,
                    }
                },
                // Use the global options object for groups
                groups: myDefaultNodeOptions,
                interaction: {
                    hover: true,
                    tooltipDelay: 100,
                },
                edges: {
                    color: { inherit: true },
                    smooth: { type: 'dynamic' }
                }
            };

            myNetwork = new vis.Network(myContainer, myGraphData, myOptions);

            // --- Interactive Click Handler ---
            myNetwork.on('click', (myProperties) => {
                const myNodeDetails = document.getElementById('myNodeDetails');
                const myClickedNodeId = myProperties.nodes[0];

                if (myClickedNodeId) {
                    if (myNetwork.isCluster(myClickedNodeId)) {
                        myNetwork.openCluster(myClickedNodeId); 
                        myNodeDetails.innerHTML = `<p class="font-bold text-blue-600">CLUSTER EXPANDED</p><p>Individual students are now visible. Click a student node for details.</p>`;
                        return; 
                    }
                    
                    // Fetch from global data set to ensure we get latest properties
                    const myNode = myGlobalNodes.get(myClickedNodeId);
                    const myGroupConfig = myDefaultNodeOptions[myNode.group] || {};
                    const myGroupColor = myGroupConfig.color ? myGroupConfig.color.background : '#333';

                    let myDetailsHtml = `
                        <p><strong>Name/Title:</strong> ${myNode.label}</p>
                        <p><strong>Role:</strong> <span class="text-xs font-mono px-2 py-1 rounded-full text-white" style="background-color: ${myGroupColor}">${myNode.group}</span></p>
                        <p><strong>Description:</strong> ${myNode.title}</p>
                    `;
                    
                    if (myNode.chaptersFinished !== undefined) {
                        
                        if (myNode.group === 'Audit') {
                            myDetailsHtml += `
                                <hr class="my-2 border-dashed">
                                <p class="font-bold text-purple-600">MLSYSBOOK.AI AUDIT STATUS</p>
                                <p>Progress tracking is not available for Audit participants in this view.</p>
                            `;
                        } else {
                            myDetailsHtml += `
                                <hr class="my-2 border-dashed">
                                <p class="font-bold text-indigo-600">MLSYSBOOK.AI PROGRESS</p>
                                <p><strong>Chapters Finished:</strong> <span class="font-semibold text-indigo-700">${myNode.chaptersFinished} / 12</span></p>
                            `;
                        }
                    }

                    myNodeDetails.innerHTML = myDetailsHtml;
                } else {
                    myNodeDetails.innerHTML = "Click on a node for details, double-click a node or edge to edit. You can also **drag nodes** to save their positions globally.";
                }
            });

            // --- Drag End Handler for Coordinate Persistence (NEW) ---
            myNetwork.on('dragEnd', async (myProperties) => {
                const myDraggedNodeId = myProperties.nodes[0];
                if (myDraggedNodeId) {
                    // 1. Get the new physical screen position
                    const myPosition = myNetwork.getPositions(myDraggedNodeId);
                    const myX = myPosition[myDraggedNodeId].x;
                    const myY = myPosition[myDraggedNodeId].y;

                    const myUpdatedNode = {
                        id: myDraggedNodeId,
                        x: myX,
                        y: myY,
                        // Set fixed true so layout/physics ignores this node on reload
                        fixed: { x: true, y: true } 
                    };

                    // 2. Update the Global DataSet
                    myGlobalNodes.update(myUpdatedNode);

                    // 3. Update the network instance to reflect fixed status instantly
                    myNetwork.setOptions({
                        nodes: {
                            [myDraggedNodeId]: { fixed: { x: true, y: true } }
                        }
                    });
                    
                    console.log(`Saved position for ${myDraggedNodeId}: (${myX.toFixed(0)}, ${myY.toFixed(0)})`);
                    document.getElementById('myNodeDetails').innerText = `Node ${myDraggedNodeId} position saved globally. Try changing views!`;
                }
            });

            // --- Double-Click Handler for Contraction AND Editing (MODIFIED) ---
            myNetwork.on('doubleClick', (myProperties) => {
                const myClickedNodeId = myProperties.nodes[0];
                const myClickedEdgeId = myProperties.edges[0];

                if (myClickedNodeId) {
                    // 1. If a node is double-clicked, check for cluster contraction or open editor
                    if (myNetwork.isCluster(myClickedNodeId)) {
                        myApplyClustering(); // Contract all clusters
                        document.getElementById('myNodeDetails').innerHTML = `<p class="font-bold text-red-600">ALL CLUSTERS CONTRACTED</p><p>The view has been simplified again.</p>`;
                    } else {
                        // Open editor for regular node
                        const myNode = myGlobalNodes.get(myClickedNodeId);
                        myOpenEditor(myNode, 'node');
                    }
                } else if (myClickedEdgeId) {
                    // 2. If an edge is double-clicked, open the editor
                    const myEdge = myGlobalEdges.get(myClickedEdgeId);
                    myOpenEditor(myEdge, 'edge');

                } else if (myProperties.nodes.length === 0 && myProperties.edges.length === 0) {
                    // 3. If background is double-clicked, contract clusters
                    if (myNetwork.getClusteredNodeIds().length > 0) {
                        myApplyClustering(); 
                        document.getElementById('myNodeDetails').innerHTML = `<p class="font-bold text-red-600">ALL CLUSTERS CONTRACTED</p><p>The view has been simplified again.</p>`;
                    }
                }
            });
            
            return myNetwork;
        }


        // --- EDITOR LOGIC ---

        // List of properties we should skip in the editor as they are complex or system-managed
        const mySkipKeys = ['id', 'from', 'to', 'x', 'y', 'fixed', 'details', 'color', 'font', 'group', 'width', 'arrows', 'title', 'type'];


        /**
         * @function myOpenEditor
         * @description Populates and displays the modal editor for a given node or edge.
         */
        function myOpenEditor(myItem, myType) {
            const myModal = document.getElementById('myEditorModal');
            const myTitle = document.getElementById('myEditorTitle');
            const myFieldsContainer = document.getElementById('myEditorFields');
            const myItemIdInput = document.getElementById('myEditorItemId');
            const myItemTypeInput = document.getElementById('myEditorItemType');

            // Clear previous content
            myFieldsContainer.innerHTML = '';
            
            // Set basic hidden properties
            myItemIdInput.value = myItem.id;
            myItemTypeInput.value = myType;
            myTitle.textContent = `Edit ${myType.charAt(0).toUpperCase() + myType.slice(1)}: ${myItem.label || myItem.id}`;

            // Build dynamic fields for all non-skipped properties
            for (const myKey in myItem) {
                if (mySkipKeys.includes(myKey)) continue;

                const myValue = myItem[myKey];
                let myInputHtml = '';

                // Handle the special case for myWeight as a number input
                if (myKey === 'myWeight') {
                     myInputHtml = `
                        <label class="block text-sm font-medium text-gray-700">${myKey} (0.0 to 1.0)</label>
                        <input type="number" step="0.01" min="0" max="1" name="${myKey}" value="${myValue}"
                               class="mt-1 block w-full border-gray-300 rounded-lg shadow-sm focus:border-primary focus:ring-primary p-2" required>
                    `;
                } else if (typeof myValue === 'number') {
                    // Simple number
                    myInputHtml = `
                        <label class="block text-sm font-medium text-gray-700">${myKey}</label>
                        <input type="number" name="${myKey}" value="${myValue}"
                               class="mt-1 block w-full border-gray-300 rounded-lg shadow-sm focus:border-primary focus:ring-primary p-2">
                    `;
                } else if (typeof myValue === 'boolean') {
                    // Simple checkbox
                    myInputHtml = `
                        <div class="flex items-center">
                            <input type="checkbox" name="${myKey}" id="edit_${myKey}" ${myValue ? 'checked' : ''}
                                class="h-4 w-4 text-primary border-gray-300 rounded focus:ring-primary">
                            <label for="edit_${myKey}" class="ml-2 block text-sm font-medium text-gray-700">${myKey}</label>
                        </div>
                    `;
                } else if (typeof myValue === 'string') {
                    // Simple text input (or label/title, etc.)
                    myInputHtml = `
                        <label class="block text-sm font-medium text-gray-700">${myKey}</label>
                        <input type="text" name="${myKey}" value="${myValue}"
                               class="mt-1 block w-full border-gray-300 rounded-lg shadow-sm focus:border-primary focus:ring-primary p-2">
                    `;
                }
                
                if (myInputHtml) {
                    const myDiv = document.createElement('div');
                    myFieldsContainer.appendChild(myDiv);
                    myDiv.innerHTML = myInputHtml; // Inject the HTML input field
                }
            }
            
            myModal.style.display = 'flex'; // Show modal
        }


        /**
         * @function mySaveChanges
         * @description Reads values from the editor form and updates the Global DataSet.
         */
        function mySaveChanges(myEvent) {
            myEvent.preventDefault();
            
            const myForm = myEvent.target;
            const myItemId = myForm.elements['id'].value;
            const myItemType = myForm.elements['type'].value;
            
            let myUpdatedItem = { id: myItemId };
            const myDataSource = myItemType === 'node' ? myGlobalNodes : myGlobalEdges;
            
            const myOriginalItem = myDataSource.get(myItemId);
            if (!myOriginalItem) return console.error("Item not found for editing.");

            // 1. Process form data and determine types
            for (let i = 0; i < myForm.elements.length; i++) {
                const myElement = myForm.elements[i];
                const myKey = myElement.name;
                
                if (!myKey || myKey === 'id' || myKey === 'type') continue;
                
                let myValue;
                
                // Get value based on input type (handle checkbox specially)
                if (myElement.type === 'checkbox') {
                    myValue = myElement.checked;
                } else {
                    myValue = myElement.value;
                }
                
                // Attempt to cast value back to original type if property existed
                if (myOriginalItem.hasOwnProperty(myKey)) {
                    const originalType = typeof myOriginalItem[myKey];
                    
                    if (originalType === 'number') {
                        myValue = parseFloat(myValue);
                        if (isNaN(myValue)) myValue = myOriginalItem[myKey]; // Fallback
                    } 
                } else if (myElement.type === 'number') {
                     // For newly added number properties, ensure they are cast correctly
                     myValue = parseFloat(myValue);
                     if (isNaN(myValue)) continue; // Skip if it's not a valid number
                }

                myUpdatedItem[myKey] = myValue;
            }

            // 2. Handle Edge Weight Visualization Refresh on the UPDATED object
            if (myItemType === 'edge' && myUpdatedItem.myWeight !== undefined) {
                // Apply visual properties to the updated item before saving
                const myProcessedEdge = myProcessEdgeForVisuals(myUpdatedItem);
                Object.assign(myUpdatedItem, myProcessedEdge);
            }
            
            // 3. Update the Global DataSet (this automatically refreshes the network view via DataView)
            myDataSource.update(myUpdatedItem);
            console.log(`Updated ${myItemType} and persisted to global data set:`, myUpdatedItem);

            myCloseEditor();
            
            document.getElementById('myNodeDetails').innerText = `Successfully updated item ID: ${myItemId}. The change is now global and will persist across views.`;
        }


        /**
         * @function myCloseEditor
         * @description Hides the modal editor.
         */
        function myCloseEditor() {
            document.getElementById('myEditorModal').style.display = 'none';
        }


        /**
         * @function mySaveViewAsJson
         * @description Saves the current state of nodes and edges (including position data) as a JSON file download.
         */
        function mySaveViewAsJson() {
            // 1. Extract all nodes and edges from the global DataSets
            const myExportData = {
                nodes: myGlobalNodes.get(),
                edges: myGlobalEdges.get()
            };
            
            // 2. Stringify the data
            const myJsonData = JSON.stringify(myExportData, null, 2);
            
            // 3. Create a Blob from the JSON data
            const myBlob = new Blob([myJsonData], { type: 'application/json' });
            
            // 4. Create a temporary link element and trigger download
            const myLink = document.createElement('a');
            myLink.href = URL.createObjectURL(myBlob);
            myLink.download = 'tinyml4d_dag_view_export.json';
            
            document.body.appendChild(myLink);
            myLink.click();
            document.body.removeChild(myLink);
            
            // 5. Clean up the URL object
            URL.revokeObjectURL(myLink.href);

            document.getElementById('myNodeDetails').innerHTML = 
                `<p class="font-bold text-primary">SUCCESS: View Exported!</p>
                 <p>The current graph data (including all saved node positions) has been saved to your downloads folder as <strong>tinyml4d_dag_view_export.json</strong>.</p>
                 <p class="text-xs text-gray-500">JSON length: ${myJsonData.length} characters.</p>`;
        }


        // --- Filtering Functions for Views ---

        /**
         * @function myGetRelevantNeighbors
         * @description Filters node and edge IDs based on allowed groups.
         * @returns {object} An object containing arrays of nodeIds and edgeIds to display.
         */
        async function myGetRelevantNeighbors(myAllowedGroups) {
            // Get all nodes from the global dataset
            const allNodes = myGlobalNodes.get();

            // 1. Filter Node IDs
            const myFilteredNodeIds = allNodes
                .filter(myNode => myAllowedGroups.includes(myNode.group))
                .map(myNode => myNode.id);

            // 2. Filter Edge IDs
            // Only show edges where BOTH ends are included in the filtered nodes
            const myFilteredEdgeIds = myGlobalEdges.get()
                .filter(myEdge => 
                    myFilteredNodeIds.includes(myEdge.from) && myFilteredNodeIds.includes(myEdge.to)
                )
                .map(myEdge => myEdge.id);

            return {
                nodeIds: myFilteredNodeIds,
                edgeIds: myFilteredEdgeIds,
            };
        }


        // --- View Loading Functions ---

        async function myLoadView(myViewName) {
            let myVisibleIds = null;
            myCurrentView = myViewName;
            
            const myNodeDetailsElement = document.getElementById('myNodeDetails');
            myNodeDetailsElement.innerText = `Filtering and Loading ${myViewName} View... Please wait.`;

            let myBaseData = {};

            // Define the groups for each view, including the new ones where relevant
            switch (myViewName) {
                case 'All':
                    myVisibleIds = { 
                        nodeIds: myGlobalNodes.getIds(), 
                        edgeIds: myGlobalEdges.getIds() 
                    };
                    break;
                case 'Professor':
                    myBaseData = await myGetRelevantNeighbors(['Professor', 'Student', 'Project', 'Publication', 'Industry', 'Hardware', 'Funding', 'Educator', 'K-12 Educator', 'Employee']);
                    myVisibleIds = myBaseData;
                    break;
                case 'MLSysBook':
                    myBaseData = await myGetRelevantNeighbors(['Educator', 'K-12 Educator', 'Student', 'Audit', 'Project', 'Professor']);
                    myVisibleIds = myBaseData;
                    break;
                case 'Industry':
                    myBaseData = await myGetRelevantNeighbors(['Industry', 'Employee', 'Professor', 'Student', 'Project', 'Hardware', 'Funding', 'LinkedIn', 'Maker']);
                    myVisibleIds = myBaseData;
                    break;
                case 'Funding':
                    myBaseData = await myGetRelevantNeighbors(['Funding', 'Project', 'Professor', 'Admin', 'LinkedIn']);
                    myVisibleIds = myBaseData;
                    break;
                case 'Discord':
                    myBaseData = await myGetRelevantNeighbors(['Discord', 'Student', 'Educator', 'K-12 Educator', 'OpenSource', 'Admin', 'Maker']);
                    myVisibleIds = myBaseData;
                    break;
                case 'LinkedIn':
                    myBaseData = await myGetRelevantNeighbors(['LinkedIn', 'Professor', 'Student', 'Industry', 'Employee', 'Funding', 'Admin', 'Publication']);
                    myVisibleIds = myBaseData;
                    break;
                case 'GitHub':
                    myBaseData = await myGetRelevantNeighbors(['GitHub', 'OpenSource', 'Student', 'Project', 'Hardware', 'Professor', 'Maker', 'Employee']);
                    myVisibleIds = myBaseData;
                    break;
                case 'Admin':
                    myBaseData = await myGetRelevantNeighbors(['Admin', 'Professor', 'Student', 'Industry', 'Funding', 'Discord', 'LinkedIn', 'GitHub']);
                    myVisibleIds = myBaseData;
                    break;
                case 'ClusteredStudent':
                    myBaseData = await myGetRelevantNeighbors(['Professor', 'Student', 'Project', 'Publication', 'Industry', 'Hardware']);
                    myVisibleIds = myBaseData;
                    break;

                default:
                    myVisibleIds = { nodeIds: myGlobalNodes.getIds(), edgeIds: myGlobalEdges.getIds() };
                    break;
            }

            if (myVisibleIds) {
                myNetwork = await myRenderNetwork('myNetworkContainer', myVisibleIds, myViewName);

                if (myViewName === 'ClusteredStudent') {
                    myApplyClustering();
                }

                myNodeDetailsElement.innerText = `Loaded ${myViewName} View. Click a node for details, double-click a node or edge to edit. You can also **drag nodes** to save their positions globally.`;
            } else {
                 myNodeDetailsElement.innerHTML = `<p class="text-red-600 font-bold">Error loading view: ${myViewName}.</p>`;
            }
        }

        // --- Initial Load and Data Initialization ---

        window.onload = () => {
            // 1. Initialize global DataSets once (Single Source of Truth)
            const myProcessedEdges = myMasterDagData.edges.map((myEdge, myIndex) => {
                // Ensure every edge has a unique ID for dataset management
                const myEdgeWithId = { ...myEdge, id: `e${myEdge.from}_${myEdge.to}_${myIndex}` }; 
                // Also apply initial weight processing
                return myProcessEdgeForVisuals(myEdgeWithId); 
            });

            myGlobalNodes = new vis.DataSet(myMasterDagData.nodes);
            myGlobalEdges = new vis.DataSet(myProcessedEdges); 
            
            // 2. Start with the 'All' view
            myLoadView('All'); 
        };
    </script>
</body>
</html>
